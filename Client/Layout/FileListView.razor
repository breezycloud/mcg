@if (Files == null || !Files.Any())
{
    <div class="text-center py-8">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No files uploaded</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by uploading some documents.</p>
    </div>
}
else
{
    <div class="space-y-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Uploaded Files (@Files.Count)</h3>
        <ul class="grid grid-cols-1 gap-2">
            @foreach (var file in Files)
            {                
                <li class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="p-4 flex items-start">
                        <!-- Icon -->
                        <div class="flex-shrink-0">
                            <FileIcon ContentType="@file.ContentType" />
                        </div>

                        <!-- Info -->
                        <div class="ml-4 flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate" title="@file.FileName">
                                @file.FileName
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">@file.FormattedSize</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                Uploaded on @file.UploadTime.ToString("g")
                            </p>

                            <!-- Actions -->
                            <div class="mt-3 flex space-x-2">
                                <!-- View/Download Button -->
                                @if (CanPreview(file))
                                {
                                    <button @onclick="() => ViewFile(file)" type="button"
                                            class="text-xs px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800">
                                        View
                                    </button>
                                }
                                else
                                {
                                    <button @onclick="() => DownloadFile(file)" type="button"
                                            class="text-xs px-3 py-1 bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600">
                                        Download
                                    </button>
                                }

                                <!-- Delete Button -->
                                @if (ShowDelete)
                                {
                                    <button @onclick="() => DeleteFile(file)" type="button"
                                            class="text-xs px-3 py-1 bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800">
                                        Delete
                                    </button>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Thumbnail Preview -->
                    @if (file.PreviewUrl != null)
                    {
                        <div class="border-t border-gray-200 dark:border-gray-700 p-2 bg-gray-50 dark:bg-gray-900">
                            <img src="@file.PreviewUrl" alt="Preview" class="w-full h-20 object-cover rounded cursor-pointer" @onclick="() => ViewFile(file)" />
                        </div>
                    }
                </li>
            }
        </ul>
    </div>
}

<!-- Fullscreen Modal for Viewing Files -->
@if (currentViewFile != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80" @onclick="CloseView" aria-modal="true" role="dialog" aria-labelledby="modal-title">
        <!-- Prevent closing when clicking inside content -->
        <div class="relative max-w-4xl max-h-full pointer-events-auto" @onclick:stopPropagation>
            <!-- Close Button -->
            <button type="button"
                    @onclick="CloseView"
                    class="absolute top-2 right-2 z-10 text-white hover:text-gray-200 bg-black/50 rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
                    aria-label="Close modal">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Modal Title (for accessibility) -->
            <h2 id="modal-title" class="sr-only">@currentViewFile.FileName</h2>

            <!-- File Preview Content -->
            <div class="bg-white rounded-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                @if (IsImage(currentViewFile.ContentType))
                {
                    <img src="@currentViewFile.PreviewUrl"
                         alt="@currentViewFile.FileName"
                         class="max-w-full h-auto object-contain p-4"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTIgMTZjMi4yMDkgMCA0LTEuNzkxIDQtNHYtNGgtNGE0IDQgMCAwIDEgNCA0em0wLTloLTJ2MmgydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYyaC0ydjFIMTJ2MWgtMnYya......' alt='Preview not available'" />
                }
                else if (IsPdf(currentViewFile.ContentType))
                {
                    <embed src="@currentViewFile.PreviewUrl"
                           type="application/pdf"
                           class="w-full h-full flex-1"
                           aria-label="PDF preview" />
                }
                else
                {
                    <iframe src="@currentViewFile.PreviewUrl"
                            class="w-full h-full flex-1 bg-white border-0"
                            title="@currentViewFile.FileName"
                            sandbox="allow-scripts allow-same-origin"
                            loading="lazy"></iframe>
                }

                <!-- File Info Bar -->
                <div class="px-4 py-2 bg-gray-50 border-t border-gray-200 text-sm text-gray-700 flex justify-between items-center">
                    <span>@currentViewFile.FileName</span>
                    <span class="text-xs text-gray-500">@FormatFileSize(currentViewFile.Size)</span>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Parameters
    [Parameter] public List<UploadResult> Files { get; set; } = new();
    [Parameter] public bool ShowDelete { get; set; } = false;
    [Parameter] public EventCallback<UploadResult> OnDelete { get; set; }

    // State
    private UploadResult? currentViewFile;

    // Check if file can be previewed in modal
    private bool CanPreview(UploadResult file) => IsImage(file.ContentType) || IsPdf(file.ContentType);

    private bool IsImage(string contentType) => contentType.StartsWith("image/");
    private bool IsPdf(string contentType) => contentType == "application/pdf";

    // View file in modal
    private void ViewFile(UploadResult file)
    {
        currentViewFile = file;
        // Optional: Scroll to top on open
        _js.InvokeVoidAsync("scrollToTop");
    }

    private void CloseView()
    {
        currentViewFile = null;
    }

    // Download file (force download)
    private async Task DownloadFile(UploadResult file)
    {
        try
        {
            await _js.InvokeVoidAsync("downloadFile", file.PreviewUrl, file.FileName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Download failed: {ex.Message}");
            // Optionally show toast or alert
        }
    }

    // Delete file
    private async Task DeleteFile(UploadResult file)
    {
        try
        {
            var confirmed = await _js.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{file.FileName}'?");
            if (confirmed)
            {
                await OnDelete.InvokeAsync(file);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Delete confirmation failed: {ex.Message}");
        }
    }

    // Format file size (e.g., 2.3 MB)
    private string FormatFileSize(long fileSize)
    {
        if (fileSize < 1024) return $"{fileSize} B";
        if (fileSize < 1024 * 1024) return $"{Math.Round(fileSize / 1024.0, 1)} KB";
        if (fileSize < 1024 * 1024 * 1024) return $"{Math.Round(fileSize / (1024.0 * 1024), 1)} MB";
        return $"{Math.Round(fileSize / (1024.0 * 1024 * 1024), 1)} GB";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            @* await _js.InvokeVoidAsync("createDownloadHelper");
            // Prevent body scrolling when modal is open
            await _js.InvokeVoidAsync("disableBodyScroll"); *@
        }
    }
}