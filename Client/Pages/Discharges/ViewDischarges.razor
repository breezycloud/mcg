@inject IDischargeService DischargeService

<div class="fixed inset-0 bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl dark:bg-gray-800">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                Discharges (@Trip!.Discharges.Count)
            </h3>
            <button @onclick="OnClose" class="text-gray-400 hover:text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 space-y-4 max-h-[90vh] overflow-y-auto">
            @if (!Trip!.Discharges.Any())
            {
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="mt-2">No discharges recorded yet</p>
                </div>
            }
            else
            {
                @foreach (var discharge in Trip!.Discharges.OrderBy(d => d.DischargeStartTime))
                {
                    <DischargeCard Data="discharge"
                                   OnDelete="DeleteDischarge"
                                   OnEdit="EditDischarge"
                                   ShowUpload="true"
                                   ShowFileDelete="true"
                                   OnFilesUploaded="@(files => SaveDischargeFiles(discharge, files))"
                                   OnFileDelete="@(file => RemoveDischargeFile(discharge, file))" />
                }
            }
        </div>
        
        <!-- Modal Footer -->
        <div class="flex items-center justify-end p-4 gap-5 border-t border-gray-200 dark:border-gray-700">
            <button @onclick="OnClose" type="button" class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700">
                Close
            </button>        
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public Trip? Trip { get; set; }
    [Parameter] public EventCallback<Discharge> OnEdit { get; set; } // NEW

    private async Task DeleteDischarge(Guid id)
    {
        try
        {
            var deleted = await DischargeService.DeleteAsync(id, AppState.GetCancellationToken());
            if (deleted)
            {
                var dischargeToRemove = Trip!.Discharges.FirstOrDefault(d => d.Id == id);
                if (dischargeToRemove != null)
                {
                    Trip!.Discharges.Remove(dischargeToRemove);
                }
                ToastService.ShowSuccess("Discharge deleted successfully", 3);
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting discharge: {ex.Message}");
        }
        finally
        {           
            StateHasChanged();
        }
    }

    private void EditDischarge(Discharge discharge)
    {
        OnEdit.InvokeAsync(discharge);
    }

    private async Task SaveDischargeFiles(Discharge discharge, List<UploadResult> files)
    {
        try
        {
            await DischargeService.UpdateAsync(discharge, AppState.GetCancellationToken());
            ToastService.ShowSuccess($"{files.Count} file(s) saved to discharge.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to save files: {ex.Message}");
        }
    }

    private async Task RemoveDischargeFile(Discharge discharge, UploadResult file)
    {
        try
        {
            await DischargeService.UpdateAsync(discharge, AppState.GetCancellationToken());
            ToastService.ShowSuccess("File removed.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to remove file: {ex.Message}");
        }
    }
}